<meta charset="utf-8">
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://www.logical-arts.jp/wp-content/uploads/distance_and_azimuth.js" charset="shift_jis"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script src="../bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?&sensor=true"></script>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SPARQL避難所</title>

    <!-- Bootstrap -->
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container text-center">
        <h1> 最寄り避難所</h1>
        <select class="form-control" onchange="init()" id="city">
            <option value="JON" selected>-都市を選んでください-</option>
            <option value="http://odp.jig.jp/rdf/jp/fukui/sabae/108">福井県鯖江市</option>
            <option value="http://odp.jig.jp/rdf/jp/hyougo/awaji/169">兵庫県淡路市</option>
            <option value="http://odp.jig.jp/rdf/jp/tokyo/shinagawa/212">東京都品川区</option>
            <option value="http://odp.jig.jp/rdf/jp/hyogo/kobe/222">兵庫県神戸市</option>
            <option value="http://odp.jig.jp/rdf/jp/chiba/nagareyama/165">千葉県流山市</option>
        </select>
        <p id="Crd" style="display:none"></p>
        <img id="Arrow" src="../bootstrap/resource/SPARQL矢印.png" style="display:none" />
        <br />
        <p id="Name" style="display:none"></p>
        <button class="btn btn-primary" id="modalButton" data-toggle="modal" data-target="#modal-example" style="display:none" onclick="setTimeout('InitializeMap()', 100)">経路を表示</button>

        <div id="res" style="display:none"></div>
        <br />
        <div class="row" style="display:none" id="opt">
            <div class="col-xs-6">
                <button onclick="telephone()" class="btn btn-primary" type="button" title="電話をかける">
                    <span class="glyphicon glyphicon-phone-alt" aria-hidden="true"></span> Tel:
                </button>
            </div>
            <div class="col-xs-6">
                <button onclick="gmap()" class="btn btn-primary " type="button" title="GoogleMapで開く">
                    <span class="glyphicon glyphicon-road" aria-hidden="true"></span> Map:
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="modal-example" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title" id="modal-label">避難経路</h4>
                </div>
                <div class="modal-body text-center">
                    <div id="map_canvas" style="width:100%; height:60%"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class=" btn btn-primary" data-dismiss="modal">閉じる</button>
                </div>
            </div>
        </div>
    </div>
    <div class="container text-center">
        <div id="CC">
            ABOUT:<br />
            各都市が公開している避難所データを元に避難を支援するWebアプリ<br />
            データはjig.jpの<a href="http://developer.odp.jig.jp/">OpenDataPlatform(odp)</a>を利用しています<br />
            <br />
            <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="クリエイティブ・コモンズ・ライセンス" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a>
            <br />APP:CC BY JON's Apps
            <br />DATA:CC BY <a href="http://developer.odp.jig.jp/">odp</a>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
    var SpotListCrd = [];
    var SpotListName = [];
    var SpotListAngle = [];
    var myCrd;
    var toCrd;
    var Tel;
    var heading = 0;
    var defAngle = 0;
    function init() {
        myCrd = "NoData";
        defAngle = 0;
        SpotListAngle.length = 0;
        SpotListName.length = 0;
        SpotListCrd.length = 0;

        if (navigator.geolocation && document.getElementById("city").options[document.getElementById("city").selectedIndex].value != "JON") {
            navigator.geolocation.getCurrentPosition(SuccessPos, function (error) {
                myCrd = "0,0";
                alert("GPS is not Working! ErrorCode:" + error.code);
            });
        } else if (document.getElementById("city").options[document.getElementById("city").selectedIndex].value != "JON") {
            alert("GPS can not Working!!");
        } else {
            document.getElementById("Name").style.display = "none";
            document.getElementById("res").style.display = "none";
            document.getElementById("opt").style.display = "none";
            document.getElementById("modalButton").style.display = "none";
            document.getElementById("Arrow").style.display = "none";
            document.getElementById("CC").style.display = "inline";
        }
    }
    function SPARQL(MyCrd) {
        var cityName = document.getElementById("city").options[document.getElementById("city").selectedIndex].value;
        const query = "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>       \
            PREFIX jrrk: <http://purl.org/jrrk#>                                    \
            PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>               \
            PREFIX geo: <http://www.w3.org/2003/01/geo/wgs84_pos#>                  \
            PREFIX schema: <http://schema.org/>                                     \
                                                                                    \
            select distinct ?label ?address ?lat ?long ?telephone{                  \
            GRAPH<"+ cityName + ">{                                                 \
            ?s  rdf:type <http://purl.org/jrrk#EmergencyFacility>;                  \
            rdfs:label ?label;                                                      \
            jrrk:address ?address ;                                                 \
            geo:lat ?lat;                                                           \
            geo:long ?long;                                                         \
            schema:telephone ?telephone;                                            \
            }}";
        var url = "http://sparql.odp.jig.jp/api/v1/sparql?query=" + encodeURIComponent(query) + "&output=json";
        d3.json(url, function (error, data) {
            var jsons = data["results"]["bindings"];
            for (var i = 0; i < jsons.length; i++) {
                SpotListCrd[SpotListCrd.length] = jsons[i].lat.value + "," + jsons[i].long.value;
                SpotListName[SpotListName.length] = jsons[i].label.value;
            }
            if (jsons.length > 0) {
                var MLB = calculate(MyCrd);
                var pName = document.getElementById("Name");
                pName.style.display = "block";
                defAngle = SpotListAngle[MLB];
                pName.innerText = "避難場所は「" + SpotListName[MLB] + "」です。";
                Tel = jsons[MLB].telephone.value;
                document.getElementById("opt").style.display = "block";
                document.getElementById("CC").style.display = "none";
            }
        });
    }
    function geoDirection(lat1, lng1, lat2, lng2) {
        var Y = Math.cos(lng2 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180 - lat1 * Math.PI / 180);
        var X = Math.cos(lng1 * Math.PI / 180) * Math.sin(lng2 * Math.PI / 180) - Math.sin(lng1 * Math.PI / 180) * Math.cos(lng2 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180 - lat1 * Math.PI / 180);
        var dirE0 = 180 * Math.atan2(Y, X) / Math.PI; // 東向きが0度の方向
        if (dirE0 < 0) {
            dirE0 = dirE0 + 360; //0～360 にする。
        }
        var dirN0 = (dirE0 + 90) % 360; //(dirE0+90)÷360の余りを出力 北向きが0度の方向
        return dirN0;
    }
    function calcdist(crd1, crd2) {
        var LonLat1 = crd1.split(",");
        var LonLat2 = crd2.split(",");
        var distAngle = distance(LonLat1[0], LonLat1[1], LonLat2[0], LonLat2[1]);
        SpotListAngle[SpotListAngle.length] = geoDirection(LonLat1[0], LonLat1[1], LonLat2[0], LonLat2[1]);
        return distAngle;
    }
    function calculate(MyCrd) {
        var ret;
        var dist = 9999999999, dis;
        for (var i = 0; i < SpotListCrd.length; i++) {
            dis = calcdist(MyCrd, SpotListCrd[i]);
            if (dist > dis) {
                dist = dis;
                ret = i;
            }
        }
        toCrd = SpotListCrd[ret];
        return ret;
    }
    function SuccessPos(position) {
        myCrd = position.coords.latitude.toString() + "," + position.coords.longitude.toString();

        SPARQL(myCrd);


        if ((navigator.userAgent.indexOf('iPhone') > 0 &&
            navigator.userAgent.indexOf('iPad') == -1) ||
            navigator.userAgent.indexOf('iPod') > 0) {
            document.getElementById("modalButton").style.display = "inline";
        } else {
            document.getElementById("res").style.display = "inline";
            setTimeout('InitializeMap()', 100);
        }
    }
    function ErrorPos(error) {
        alert("GPS is not Working! ErrorCode:" + error.code);
    }

    function InitializeMap() {
        var directionService = new google.maps.DirectionsService();
        var directionDisplay = new google.maps.DirectionsRenderer();
        var now = new google.maps.LatLng();
        var mapOptions = { mapTypeId: google.maps.MapTypeId.ROADMAP };
        var map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
        directionDisplay.setMap(map);

        var start = myCrd;
        var end = toCrd;
        var request = { origin: start, destination: end, travelMode: google.maps.TravelMode.DRIVING };
        directionService.route(request, function (result, status) {
            if (status == google.maps.DirectionsStatus.OK) {
                directionDisplay.setDirections(result);
            }
        });
    }

    function telephone() {
        location.href = "tel:" + Tel;
    }
    function gmap() {
        location.href = "http://maps.apple.com/maps?&saddr=" + myCrd + "&daddr=" + toCrd;
    }

    function iOS(e) {
        //iOS標準コンパス取得
        heading = e.webkitCompassHeading - defAngle;
        if (heading < 0) heading += 360;
        heading += window.orientation;
        Arrow.style.webkitTransform = 'rotate(-' + (heading) + 'deg)';

        window.addEventListener("compassneedscalibration", function (event) {
            alert('コンパスが正しくありません。8の字を描くようにデバイスを動かしてください。');
            event.preventDefault();
        }, true);

        if (document.getElementById("city").options[document.getElementById("city").selectedIndex].value != "JON")
            document.getElementById("Arrow").style.display = "inline";
    }
    function android() {
        var map = document.createElement("div");
        document.getElementById("res").appendChild(map);
        map.setAttribute("id", "map_canvas");
        map.style.width = "100%";
        map.style.height = "60%";

    }
    window.addEventListener('load', function () {
        if ((navigator.userAgent.indexOf('iPhone') > 0 &&
            navigator.userAgent.indexOf('iPad') == -1) ||
            navigator.userAgent.indexOf('iPod') > 0) {
            window.addEventListener('deviceorientation', iOS, false);
        } else if (navigator.userAgent.indexOf('Android') > 0) {
            android();
        } else {
            android();
            /*document.getElementById("res").innerHTML = "<br/><br/><h3>そのデバイスは対応しておりません。</h3>";
            document.getElementById("city").style.display = "none";*/
        }
    }, false);
</script>
